<html>
<head>
	<title>WebAudioPlayer</title>

	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
	<script type="text/javascript" src="jquery.xdomainajax.js"></script>
	
	<!-- Players:
	http://jplayer.org/
	http://wpaudioplayer.com/standalone/
	-->
	<script type="text/javascript" src="http://jplayer.org/2.1.0/js/jquery.jplayer.min.js"></script>
	<link href="http://jplayer.org/latest/skin/blue.monday/jplayer.blue.monday.css" rel="stylesheet" type="text/css" />

	<style type="text/css">
		.song { background-color: #CCDDCC }
		.song-selected { background-color: #00FF00 }
	</style>

</head>

<body>
	<form action="javascript:updateContentUrl()">
		Content URL:
		<input type="text" id="content_url" size="60" value="http://mp3.hhe.cc/Red%20Hot%20Chili%20Peppers/">
		<input type="submit" value="update">
	</form>
	<div id="content_state"></div>
	<div id="player" class="jp-jplayer"></div>
		<div id="jp_container_1" class="jp-audio">
			<div class="jp-type-single">
				<div class="jp-gui jp-interface">
					<ul class="jp-controls">
						<li><a href="javascript:;" class="jp-play" tabindex="1">play</a></li>
						<li><a href="javascript:;" class="jp-pause" tabindex="1">pause</a></li>
						<li><a href="javascript:;" class="jp-stop" tabindex="1">stop</a></li>
						<li><a href="javascript:;" class="jp-mute" tabindex="1" title="mute">mute</a></li>
						<li><a href="javascript:;" class="jp-unmute" tabindex="1" title="unmute">unmute</a></li>
						<li><a href="javascript:;" class="jp-volume-max" tabindex="1" title="max volume">max volume</a></li>
					</ul>
					<div class="jp-progress">
						<div class="jp-seek-bar">
							<div class="jp-play-bar"></div>
						</div>
					</div>
					<div class="jp-volume-bar">
						<div class="jp-volume-bar-value"></div>
					</div>
					<div class="jp-current-time"></div>
					<div class="jp-duration"></div>
					<ul class="jp-toggles">
						<li><a href="javascript:;" class="jp-repeat" tabindex="1" title="repeat">repeat</a></li>
						<li><a href="javascript:;" class="jp-repeat-off" tabindex="1" title="repeat off">repeat off</a></li>
					</ul>
				</div>
				<div class="jp-title">
					<ul>
						<li></li>
					</ul>
				</div>
				<div class="jp-no-solution">
					<span>Update Required</span>
					To play the media you will need to either update your browser to a recent version or update your <a href="http://get.adobe.com/flashplayer/" target="_blank">Flash plugin</a>.
				</div>
			</div>
		</div>
	
	<a href="javascript:prevSong()" class="button-prev-song">prev</a>
	<a href="javascript:nextSong()" class="button-next-song">next</a>

	<hr>
	<div id="content"></div>
</body>

<script type="text/javascript">

String.prototype.endsWith = function(suffix) {
    return this.indexOf(suffix, this.length - suffix.length) !== -1;
};

$(document).ready(function() {
	console.log("document ready");

	$("#player").jPlayer({
		ready: function(ev) {
			console.log("jPlayer ready");
			var hashurl = window.location.hash.substr(1);
			if(hashurl) content_url.value = hashurl;
			updateContentUrl();
		},
		ended: function(ev) { nextSong(); },
		swfPath: "http://www.jplayer.org/2.1.0/js",
		solution: "html",
		supplied: "mp3"
	});

});

function updateContentUrl() {
	var url = content_url.value;
	console.log("update content URL: " + url);

	$("#content_state")
		.text("loading " + url + " ...")
		.css({"text-decoration":"blink", "color":"grey"});

	$("#content").html("");

	$.ajax({
		url: url,
		type: "GET",
		success: function(res) {
			$("#content_state").text("success!");

			$(res.responseText).find("a").each(function() {
				var linktext = $(this).text();
				var linkurl = url + $(this).attr("href");
				if(!linkurl.endsWith(".mp3")) return;

				jQuery("<li>", {
					html: jQuery("<a>", {
						href: linkurl,
						text: linktext,
						class: "song",
						click: function(ev) { ev.preventDefault(); onSongClick($(this)); },
					})
				}).appendTo($("#content"));
			});

			nextSong();
		},
		fail: function() {
			console.log("failed to load");
			$("#content_state")
				.text("failed to load")
				.css("color","red");
		}
	});
}

function onSongClick(song) {
	var songurl = song.attr("href");
	console.log("onSongClick: " + songurl);
	var curselected = $.find("a.song-selected")[0];
	if(curselected) {
		$(curselected).removeClass("song-selected");
	}

	song.addClass("song-selected");

	$("#player")
		.jPlayer("setMedia", { mp3: songurl })
		.jPlayer("play");
	
	$(".jp-title").text(song.text());
}

function prevSong() {
	var cur = $("a.song-selected");
	if(cur[0]) {
		var prev = cur.parent().prevAll().find("a")[0];
		$(prev).click();
	}
}

function nextSong() {
	var cur = $("a.song-selected");
	var next;
	if(cur[0])
		next = cur.parent().nextAll().find("a")[0];
	else
		next = $(".song")[0];
	console.log("next: " + next.text);
	$(next).click();
}

</script>

</html>
